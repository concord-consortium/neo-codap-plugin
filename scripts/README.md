# Utility Scripts

This directory contains utility scripts for the neo-codap-plugin project.

## Downloading data from NEO Site

### scrape-neo-images.ts

This script pulls down information about each image in the datasets we care about. That list of datasets is specified in `neo-dataset-configs.ts`. For each dataset it figures out the max resolution supported. And then it figures out all of the available dates for the dataset and what the image id is. These image ids are needed for download the actual image. The results are stored in the `neo-dataset-images.json` file which is checked into this repository and used by the runtime code.

### download-neo-images.ts

This script uses the info from `neo-dataset-images.json` to download all of the images for each dataset and stores them in a folder structure. All of these images are then manually updated to S3 so the runtime code can download them more efficiently and not bog down the NASA server.

## Create Physical Value Functions

This collection of scripts are used to figure out the `paletteToValue` functions that are in `neo-dataset-configs.ts`.

The scripts use "images" that were manually downloaded into the `/scripts/neo-images` folder. The structure of that folder should be self explanatory.

### check-png-palette.ts

This script verifies that we can read the palette and palette indices from a png file.

### create-color-mapping.ts

This script looks at a csv "image" and a png image for the same date from a NEO dataset. It then creates a mapping from the png's palette index to the physical value specified in the csv "image". This mapping is saved as `color-mapping.csv`. The `color-mapping.csv` can be looked at in CODAP or a spreadsheet to visualize the relationship between the palette indices and the physical values. This file is also used for the `analyze-value-function` described below.

To generate the color mapping for different datasets the `kDatasetId` and `kImageDate` constants have to be updated in the script so it can find the correct files in the `/scripts/neo-images` folder.

This script has to use a forked version for the `png-codec` library. It needs to get the actual palette indices from the png file, not just the colors. This is because in some datasets the same color is used for multiple palette indices. However there are different physical values used for these same colors.

## analyze-value-function.ts

This script was mostly generated by Cursor. It looks at the `color-mapping.csv` file and tries to find the best linear, logarithmic, or power function to fit the curve of the data. In some datasets the physical value at palette index 0 has to be special cased. Additionally in all datasets we've looked at so far the physical value of palette entry 255 is 99999.00. We are interpreting this to mean that there is no data at this pixel.

With these entries removed from the data, the curve fits nearly perfectly for all of the datasets we are using.

## Service Discovery Tool

### list-bonjour-services.mjs

This script uses the `bonjour-service` package to discover and list all Bonjour/Zeroconf services on your local network. This was used to debug issues when setting up the automatic port discover used by the Playwright tests, so they can figure out which port the local server is running on.

#### Usage

You can run the service discovery tool using npm:

```bash
npm run discover-services
```

The script will continuously monitor for services being advertised on your local network using Bonjour/Zeroconf (also known as mDNS). For each service, it will display:

- Service name
- Service type
- Host
- IP address(es)
- Port
- Subtypes (if any)
- Protocol
- Flags (if any)
- TXT records (if any)

This can be particularly useful for:

1. Debugging network connectivity issues
2. Discovering available services on your local network
3. Verifying that your own services are being advertised correctly

#### Terminating the Script

The script will run continuously until manually stopped. To stop the script, press `Ctrl+C` in the terminal.

